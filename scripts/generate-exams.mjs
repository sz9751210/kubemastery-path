import fs from 'fs';
import path from 'path';
import matter from 'gray-matter';

const EXAMS_DIR = path.join(process.cwd(), 'src/content/exams');
const OUTPUT_FILE = path.join(process.cwd(), 'src/data/generated-exams.ts');

async function generateExams() {
    if (!fs.existsSync(EXAMS_DIR)) {
        console.log('No exams directory found.');
        return;
    }

    const exams = {};

    // Recursive function to walk directories
    function walkDir(dir) {
        const files = fs.readdirSync(dir);
        for (const file of files) {
            const filePath = path.join(dir, file);
            const stat = fs.statSync(filePath);
            if (stat.isDirectory()) {
                walkDir(filePath);
            } else if (file.endsWith('.md')) {
                const content = fs.readFileSync(filePath, 'utf8');
                try {
                    // Parse frontmatter
                    const { data, content: markdownBody } = matter(content);
                    if (!data.id) {
                        console.warn(`Skipping ${file}: Missing id in frontmatter`);
                        continue;
                    }

                    // Helper to extract verify and setup blocks
                    const extractScripts = (md) => {
                        const verifyRegex = /```verify\n([\s\S]*?)\n```/g;
                        const setupRegex = /```setup\n([\s\S]*?)\n```/g;

                        let verifyScript = '';
                        let setupScript = '';

                        let cleanMd = md.replace(verifyRegex, (match, script) => {
                            verifyScript += script + '\n';
                            return ''; // Remove from display
                        });

                        cleanMd = cleanMd.replace(setupRegex, (match, script) => {
                            setupScript += script + '\n';
                            return ''; // Remove from display
                        });

                        return { cleanMd, verifyScript, setupScript };
                    };

                    const { cleanMd: mainMarkdown, verifyScript: mainVerify, setupScript: initialSetup } = extractScripts(markdownBody);

                    // Auto-generate setup script if missing
                    let mainSetup = initialSetup;
                    if (!mainSetup) {
                        const hasCrictl = mainMarkdown.includes('crictl');
                        const hasKubectl = mainMarkdown.includes('kubectl');

                        if (hasCrictl) {
                            mainSetup = 'echo "Environment Ready (Auto-generated)"\n';
                        } else if (hasKubectl) {
                            mainSetup = 'echo "Environment Ready (Auto-generated)"\n';
                        } else {
                            mainSetup = 'echo "Environment Ready"\n';
                        }
                    }

                    // Split tasks for randomization
                    // We look for "# Task" at the start of a line
                    const rawTasks = markdownBody.split(/^# Task /m)
                        .filter(t => t.trim().length > 0)
                        .map(t => '# Task ' + t); // Re-add the header back

                    const parsedTasks = rawTasks.map(t => {
                        const { cleanMd, verifyScript, setupScript } = extractScripts(t);
                        return { markdown: cleanMd, verify: verifyScript, setup: setupScript };
                    });

                    const finalTasks = parsedTasks.length > 1 ? parsedTasks : [];

                    // Ensure ID is a string
                    const lessonId = String(data.id);

                    exams[lessonId] = {
                        ...data,
                        id: lessonId,
                        markdown: mainMarkdown,
                        verifyScript: mainVerify,
                        setupScript: mainSetup,
                        tasks: finalTasks,
                    };
                } catch (e) {
                    console.error(`Error parsing ${file}:`, e);
                }
            }
        }
    }

    walkDir(EXAMS_DIR);

    const fileContent = `// Auto-generated by scripts/generate-exams.mjs
import { Lesson } from './types';

export const generatedExams: Record<string, Lesson> = ${JSON.stringify(exams, null, 2)};
`;

    fs.writeFileSync(OUTPUT_FILE, fileContent);
    console.log(`Generated ${Object.keys(exams).length} exams to ${OUTPUT_FILE}`);
}

generateExams();
